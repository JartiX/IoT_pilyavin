# Управление освещением с обменом данными по MQTT

## Описание проекта

Данный проект представляет собой распределённую IoT-систему автоматического управления освещением на основе данных о внешней освещённости. Система состоит из двух микроконтроллеров Arduino, взаимодействующих с компьютерами через UART-соединение, которые в свою очередь обмениваются данными через MQTT-брокер.

### Концепция работы

Система реализует классический паттерн IoT-архитектуры "сенсор-актуатор" с распределённой логикой принятия решений:

1. **Сенсорный модуль** непрерывно измеряет уровень освещённости окружающей среды с помощью фоторезистора
2. **Публикатор** транслирует данные датчика в облачный MQTT-брокер
3. **Подписчик** получает данные освещённости и принимает решение о необходимости включения/выключения искусственного освещения
4. **Исполнительный модуль** управляет светодиодом согласно командам от подписчика
5. **Монитор** отслеживает все сообщения в системе для контроля корректности работы

## Архитектура системы

```
┌─────────────────┐         ┌──────────────────────────────┐
│   Sensor MCU    │<--UART->│PC1: Publisher (publisher.py) │
│ (light_sensor)  │         │   ├─ Считывает данные        │
│                 │         │   └─ Публикует в MQTT        │
└─────────────────┘         └──────────────┬───────────────┘
                                           │
                                           v
                            ┌──────────────────────────┐
                            │     MQTT Broker          │
                            │   (broker.emqx.io)       │
                            └──────────┬───────────────┘
                                       │
                    ┏──────────────────┼──────────────────┓
                    v                  v                  v
         ┌────────────────────┐  ┌──────────┐  ┌─────────────────┐
         │ PC2: Subscriber    │  │ Monitor  │  │   Actuator MCU  │
         │ (subscriber.py)    │  │   PC     │  │      (led)      │
         │  ├─ Подписан на    │  │          │  │                 │
         │  │  luminosity     │  │          │  │                 │
         │  ├─ Анализирует    │  │          │  │                 │
         │  │  данные         │  │          │  │                 │
         │  └─ Отправляет     │  │          │  │                 │
         │     команды MCU    │  │          │  │                 │
         │  └─ Публикует      │  │          │  │                 │
         │     состояние в    │  │          │  │                 │
         │     MQTT           │  │          │  │                 │
         │                    │  │          │  │                 │
         └─────────┬──────────┘  └──────────┘  └────────▲────────┘
                   │                                     │
                   └────────────────UART─────────────────┘
```

### Топики MQTT

Система использует следующие топики для обмена данными:

- `pilyavin/greenhouse/luminosity` — публикация значений освещённости
- `pilyavin/greenhouse/light_state` — статус светодиода (LED_GOES_ON/LED_GOES_OFF)

## Протокол взаимодействия

### Команды для микроконтроллера-датчика (PC → Sensor MCU)

| Команда | Описание | Ответ MCU |
|---------|----------|-----------|
| `p` | Запросить единичное значение с фоторезистора | `SENSOR_VALUE:<value>\n` |
| `s` | Начать потоковую передачу данных | `STREAM_STARTED\n` |

### Команды для микроконтроллера-исполнителя (PC → Actuator MCU)

| Команда | Описание | Ответ MCU |
|---------|----------|-----------|
| `u` | Включить светодиод (up) | `LED_GOES_ON\n` |
| `d` | Выключить светодиод (down) | `LED_GOES_OFF\n` |

## Компоненты системы

### 1. Микроконтроллер-датчик (light_sensor.ino)

Отвечает за считывание данных с фоторезистора, подключённого к аналоговому входу A0.

**Основные функции:**
- `setup()` — инициализация последовательного порта (9600 baud) и настройка пина A0 как входа
- `UpdateState(int lightValue)` — обработка команд от ПК и формирование ответов
- `loop()` — непрерывное считывание значения с датчика

**Логика работы:**
- В режиме ожидания микроконтроллер постоянно считывает аналоговое значение с пина A0 (диапазон 0-1023)
- По команде `p` отправляет текущее значение в формате `SENSOR_VALUE:<value>`
- По команде `s` переходит в потоковый режим и отправляет подтверждение `STREAM_STARTED`

### 2. Микроконтроллер-исполнитель (led.ino)

Управляет светодиодом, подключённым к пину 13 (LEDBUILTIN).

**Основные функции:**
- `setup()` — инициализация последовательного порта
- `updateState()` — приём и обработка команд управления светодиодом
- `handleLED()` — установка состояния светодиода согласно текущей команде
- `loop()` — непрерывный цикл обновления состояния и управления LED

**Логика работы:**
- Микроконтроллер поддерживает внутреннее состояние `LED_STATE` (по умолчанию 'd' — выключен)
- По команде `u` включает светодиод и отправляет подтверждение `LED_GOES_ON`
- По команде `d` выключает светодиод и отправляет подтверждение `LED_GOES_OFF`

### 3. Публикатор (publisher.py)

Связующее звено между микроконтроллером-датчиком и MQTT-брокером.

**Алгоритм работы:**
1. Устанавливает UART-соединение с микроконтроллером-датчиком (COM3, 9600 baud)
2. Подключается к MQTT-брокеру с уникальным client_id
3. Отправляет команду `s` для активации потокового режима датчика
4. В цикле (1800 итераций с интервалом 10 секунд):
   - Отправляет команду `p` для запроса значения
   - Считывает ответ вида `SENSOR_VALUE:<value>`
   - Извлекает числовое значение освещённости
   - Публикует значение в топик `pilyavin/greenhouse/luminosity` с QoS=2

**Особенности реализации:**
- Использование `loop_start()` для асинхронной обработки сетевых событий
- Задержка 0.1 секунды после отправки команды для гарантированного получения ответа
- Парсинг ответа через `split('SENSOR_VALUE:', 1)[1]` для извлечения значения

### 4. Подписчик (subscriber.py)

Принимает решения об управлении освещением на основе данных от датчика.

**Алгоритм работы:**
1. Устанавливает UART-соединение с микроконтроллером-исполнителем (COM5, 9600 baud)
2. Подключается к MQTT-брокеру и подписывается на топик `pilyavin/greenhouse/luminosity`
3. При получении сообщения о значении освещённости:
   - Если значение > 30 и свет включён → отправляет команду `d` (выключить)
   - Если значение ≤ 30 и свет выключен → отправляет команду `u` (включить)
4. Считывает подтверждение от микроконтроллера (LED_GOES_ON/LED_GOES_OFF)
5. Публикует статус светодиода в топик `pilyavin/greenhouse/light_state`

**Пороговая логика:**
Низкие значения, т.к мой фоторезистор при дневном освещении выдает значения выше 30, в условиях отсутствия света в пределах от 0 до 30

### 5. Монитор (monitor.py)

Независимый инструмент для мониторинга всех событий в системе.

**Функциональность:**
- Подписывается одновременно на все топики системы:
  - `pilyavin/greenhouse/luminosity` — данные освещённости
  - `pilyavin/greenhouse/light_state` — статусы светодиода
- Выводит в консоль все полученные сообщения с указанием топика и содержимого
- Работает непрерывно до нажатия Ctrl+C
- Корректно завершает соединение при остановке

**Применение:**
Монитор позволяет в реальном времени отслеживать:
- Частоту публикации данных датчика
- Своевременность реакции системы на изменение освещённости
- Корректность передачи статусов исполнительного устройства
- Наличие ошибок или потерь сообщений

## Логика работы системы

### Временные характеристики

- **Интервал измерений:** 10 секунд
- **Время отклика системы:** ~0.5-1 секунда (от измерения до управления LED)
- **Период работы:** 1800 итераций × 10 секунд = 5 часов непрерывной работы. При необходимости можно сделать бесконечный цикл
- **QoS уровень:** 2 (exactly once) — гарантирует доставку каждого сообщения ровно один раз

## Требования к аппаратуре

### Компоненты

- 2× Arduino-совместимых микроконтроллера (например, Arduino Uno, Nano)
- 1× Фоторезистор
- 2× Резистор
- 1× Светодиод (любого цвета)
- 2× USB/typeC - кабеля для подключения микроконтроллеров к ПК
- Соединительные провода

### Схема подключения

![](/docs/scheme.png)

## Требования к программному обеспечению

### Зависимости Python

```bash
pip install paho-mqtt
pip install pyserial
```

### Настройка окружения

1. **Проверка установки Python:**
   ```bash
   python --version  # Требуется Python 3.7+
   pip --version
   ```

2. **Проверка доступности MQTT-брокера:**
   ```bash
   ping broker.emqx.io
   ```

3. **Определение COM-портов:**
   - Windows: через Диспетчер устройств (обычно COM3 или COM5)
   - Linux: `/dev/ttyUSB0`, `/dev/ttyACM0` и т.д.
   - macOS: `/dev/cu.usbserial-*`

4. **Загрузка прошивок:**
   - Загрузить `light_sensor.ino` на первый микроконтроллер через Arduino IDE
   - Загрузить `led.ino` на второй микроконтроллер
   - Запомнить COM-порты каждого устройства

## Запуск системы

### Порядок запуска

1. **Подготовка:**
   ```bash
   # Клонировать репозиторий и перейти в папку проекта
   cd IoT_pilyavin/MQTT
   
   # Установить зависимости
   pip install -r requirements.txt
   ```

2. **Настройка COM-портов:**
   - Отредактировать `publisher.py`: указать порт датчика в `serial.Serial('COMx', ...)`
   - Отредактировать `subscriber.py`: указать порт исполнителя в `serial.Serial('COMy', ...)`

3. **Запуск компонентов (в отдельных терминалах):**
   ```bash
   # Терминал 1: Публикатор
   python src/publisher.py
   
   # Терминал 2: Подписчик
   python src/subscriber.py
   
   # Терминал 3: Монитор (опционально)
   python src/monitor.py
   ```

## Возможные проблемы и решения

### COM-порт занят
**Проблема:** `serial.serialutil.SerialException: could not open port`
**Решение:** Закрыть Arduino IDE и другие программы, использующие порт. Проверить правильность имени порта.

### Нет подключения к MQTT
**Проблема:** `Failed to connect, return code 1`
**Решение:** Проверить интернет-соединение, доступность брокера (`ping broker.emqx.io`), настройки firewall.

### Дублирование client_id
**Проблема:** Постоянные переподключения к брокеру
**Решение:** Убедиться, что каждый скрипт генерирует уникальный `client_id` через `random.randint()`.

### Светодиод не реагирует
**Проблема:** Команды отправляются, но LED не меняет состояние
**Решение:** Проверить правильность подключения LED (в 13 пин) и резистора, убедиться в корректности пина в коде LEDBUILTIN.

### Нестабильные показания датчика
**Проблема:** Значения сильно "прыгают"
**Решение:** Добавить сглаживание (среднее по нескольким измерениям) в коде микроконтроллера или Python-скрипте.